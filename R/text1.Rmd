---
title: "Obtaining odds ratios from logistic regression"
author: "Nicol√°s Molano Gonzalez"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2: default
bibliography: references.bib  
---

```{r echo=F, message = FALSE, warning =F}
library(pacman)
library(pacman)
p_load(here)
p_load(tidyverse)
p_load(reshape2)
p_load(boot)
p_load(epitools)
p_load(kableExtra)
p_load(knitr)
p_load(ggmosaic)
set.seed(150)
```

# Introduction
Odds ratios are the prefered effect measure in health sciences to describe asociations between an dichotumous outcome of interest and a categorical variable, most often dichotumous, but not always. Lets start this discution with an example.

## Example1
```{r echo=FALSE, results = 'asis',message = FALSE, warning =F}
ca_ctr_r<-.3
n<-250
nCA<-round(n*ca_ctr_r)
z0<-data.frame(status=c(rep("flu",nCA),rep("no_flu",n-nCA)))
z0$vac<-NA
exp_CA<-.35
exp_CTR<-.75
z0[z0$status %in% "flu","vac"]<-ifelse(runif(nCA)<exp_CA,"yes","no")
z0[z0$status %in% "no_flu","vac"]<-ifelse(runif(n-nCA)<exp_CTR,"yes","no")
z0$vac<-factor(z0$vac,levels = c("yes","no"))
```

Considere an study in which `r n` patients are interrogated about having taken any vaccinations against seasonal flu (vac) and diagnostiqued in the past six monts with seasonal flu (flu). The data of the study can be summarized in the following contingency table (\@ref(tab:conttabl))

```{r conttabl, echo=FALSE}
###see http://haozhu233.github.io/kableExtra/awesome_table_in_html.html
res<-kable(t(table(z0)%>%addmargins),caption="contingency table of flu vs vac")
kable_styling(res,"striped", position = "center",full_width = F)%>% add_header_above(c("vac","status"=2," "))
# res<-t(table(z0)%>%addmargins)  
# knitr::kable(res,caption="Tabla de contingencia: status vs exposition")
```
The main interest in this study is to determine if the proportion of patients diagnostiqued with flu is diferent depending on the intake of the vaccine. A first approach to this, is to compute conditional proportions of infections for those that were exposed to the vaccine and for those who not. This is easly done by calculating the row proportions in the table \@ref(tab:conttabl), as shown below

```{r proptable, echo=FALSE}
###see http://haozhu233.github.io/kableExtra/awesome_table_in_html.html
resprop<-kable(t(table(z0))%>%prop.table(1),caption="row proportions of flu vs vac")
kable_styling(resprop,"striped", position = "center",full_width = F)%>% add_header_above(c("vac","status"=2))
# res<-t(table(z0)%>%addmargins)
# knitr::kable(res,caption="Tabla de contingencia: status vs exposition")

or1<-t(table(z0))%>%oddsratio
```
As can be seen in table \@ref(tab:proptable), proportion of infections is higher in the group of no vaccination. Lets calculate de OR for this table, defined as: 

\begin{equation}
OR_{p_{vac}|p_{no \; vac}}=\frac{\frac{p_{vac}}{1-p_{vac}}}{\frac{p_{no \;vac}}{1-p_{no \;vac}}} (\#eq:or1)
\end{equation}

Where $p_{vac}$ stands for the proportion of patients with flu which were previously vaccinted, or more exactly, in terms of conditional probabilities:$p_{vac}=P(flu|vac)$. Similarly $p_{no \;vac}$ stands for the proportion of patients with flu which did not recive any vaccination or $P(flu|no \;vac)$. Therefore
$OR_{p_{vac}|p_{no \; vac}}=$ `r or1$measure[2,1]`, and the $95\% \; CI=$ `r or1$measure[2,2:3]`

It is very important to note that the different OR's can be computed from this same table. If we transpose the table we get this

```{r trasconttabl, echo=FALSE}
###see http://haozhu233.github.io/kableExtra/awesome_table_in_html.html
res<-kable(table(z0)%>%addmargins,caption="contingency table of vac vs flu")
kable_styling(res,"striped", position = "center",full_width = F)%>% add_header_above(c("flu","vac"=2," "))
# res<-t(table(z0)%>%addmargins)  
# knitr::kable(res,caption="Tabla de contingencia: status vs exposition")
or2<-table(z0)%>%oddsratio
```
Calculating the OR from this table we obtain the following:

\begin{equation}
OR_{p_{flu}|p_{no \; flu}}=\frac{\frac{p_{flu}}{1-p_{flu}}}{\frac{p_{no \;flu}}{1-p_{no \;flu}}} (\#eq:or2)
\end{equation}

Now, $p_{flu}$ stands for the proportion of patients with flu that were vaccinated, that is $P(vac|flue)$ and $p_{no \;flu}$ stands for the proportion of patients without flu which did not recive any vaccination (i.e $P(vac|no \; flu)$). Therefore
$OR_{p_{flu}|p_{no \; flu}}=$ `r or2$measure[2,1]`, and the $95\% \; CI=$ `r or2$measure[2,2:3]`

As can be seen 
$$OR_{p_{vac}|p_{no \; vac}}=OR_{p_{flu}|p_{no \; flu}}$$
although they are the same, the conditional probabilities analised are very diferent

```{r proptable2, echo=FALSE}
###see http://haozhu233.github.io/kableExtra/awesome_table_in_html.html
resprop2<-kable(table(z0)%>%prop.table(1),caption="row proportions of vac vs flu")
kable_styling(resprop,"striped", position = "float_left",full_width =F)%>% add_header_above(c("vac","status"=2))
kable_styling(resprop2,"striped", position = "left",full_width = F)%>% add_header_above(c("flu","vac"=2))
```

Still, there exist another posible OR calculation for the same data set. Consider swaping the columns in table \@ref(tab:conttabl), obtaining this:

```{r conttablinv, echo=FALSE}
###see http://haozhu233.github.io/kableExtra/awesome_table_in_html.html
z0$status<-factor(z0$status,levels = c("no_flu","flu"))
res<-kable(t(table(z0)%>%addmargins),caption="contingency table of flu vs vac")
kable_styling(res,"striped", position = "center",full_width = F)%>% add_header_above(c("vac","status"=2," "))

or3<-t(table(z0))%>%oddsratio
```

calculating the OR for this table now looks like this:
\begin{equation}
OR_{q_{vac}|q_{no \; vac}}=\frac{\frac{q_{vac}}{1-q_{vac}}}{\frac{q_{no \;vac}}{1-q_{no \;vac}}} (\#eq:or3)
\end{equation}

where $q_{vac}=P(no \; flu|vac)=1-P(flu|vac)$ and $q_{no \;vac}=P(no \; flu|no \;vac)=1-p_{no \;vac}$. Therefore
$OR_{q_{vac}|q_{no \; vac}}=$ `r or3$measure[2,1]`, and the $95\% \; CI=$ `r or3$measure[2,2:3]`

You can verify that indeed 

$$OR_{p_{vac}|p_{no \; vac}}=1/OR_{q_{vac}|q_{no \; vac}}$$
In conclucion, for a $2 \times 2$ table two different OR's can be computed and they are related since one is the multiplicative inverse of the other. However there exist more than two posible configurations for the contingency table associated with this two OR and the configuration of the table is very important since it is related with the conditional probabilities analysed.

# Odds ratios for $K \times 2$ tables

OR's can be used to characterize the associatiosn of between an dichotumous outcome of interest and a categorical variable with nore than two categories. Consider the next example.

## Example 2

```{r echo=FALSE, results = 'asis',message = FALSE, warning =F}
N<-1000

treatment<-sample(LETTERS[1:3],N,replace =T)

cons<-NA
cons[treatment %in% "A"]<-rnorm(sum(treatment %in% "A"),100,10)
cons[treatment %in% "B"]<-rnorm(sum(treatment %in% "B"),100,10)
cons[treatment %in% "C"]<-rnorm(sum(treatment %in% "C"),100,10)

sim_probs<-rep(NA,N)

eqmA<-matrix(c(1,min(cons),
               1,max(cons)),byrow = T,nrow=2)
eqbA<-qlogis(c(.01,.6))
Abetas<-solve(eqmA,eqbA)

eqmB<-matrix(c(1,min(cons),
               1,max(cons)),byrow = T,nrow=2)
eqbB<-qlogis(c(.3,.9))
Bbetas<-solve(eqmB,eqbB)

eqmC<-matrix(c(1,min(cons),
               1,max(cons)),byrow = T,nrow=2)
eqbC<-qlogis(c(.99,.4))
Cbetas<-solve(eqmC,eqbC)

sim_probs[treatment %in% "A"]<-inv.logit(Abetas[1]+Abetas[2]*cons[treatment %in% "A"])
sim_probs[treatment %in% "B"]<-inv.logit(Bbetas[1]+Bbetas[2]*cons[treatment %in% "B"])
sim_probs[treatment %in% "C"]<-inv.logit(Cbetas[1]+Cbetas[2]*cons[treatment %in% "C"])

z0<-data.frame(treatment,cons,sim_probs,stringsAsFactors = T)
z0$BM<-map_dbl(z0$sim_probs,~rbinom(1,1,.))
z0$BM<-factor(z0$BM,level=0:1,labels = c("No","Yes"))
```

A researcher has `r N` mice which were asigned randomly to one of `r length(levels(z0$treatment))` treatments: `r levels(z0$treatment)`. The researchers were interested in how the treatment is related to behavior modifications ($BM=Yes$) or not ($BM=No$). Table \@ref(tab:ex2t1) presents the rewsults of this experiment.

```{r ex2t1, echo=FALSE}
z0$BM<-relevel(z0$BM,ref="Yes")
###see http://haozhu233.github.io/kableExtra/awesome_table_in_html.html
ex2t1<-kable(table(z0[,c("treatment","BM")])%>%addmargins,caption="contingency table of treatment vs behavior modifications")
kable_styling(ex2t1,"striped", position = "center",full_width = F)%>% add_header_above(c("treatment","BM"=2," "))
# res<-t(table(z0)%>%addmargins)  
# knitr::kable(res,caption="Tabla de contingencia: status vs exposition")
```

It must be noted that the objective of this experiment is to study the following conditional probabilities:
$$P(BM=Yes|Treatment=A), \;(BM=Yes|Treatment=B), \;(BM=Yes|Treatment=C)$$
And to assess wether they differ at all, which is biger, etc. How OR's can help us to characterise the change in conditional distributions of behavior modifications given the treatments asigned? OR's are designed to measure the association between dichotumous variables, however, here one of the variables has `r length(levels(z0$treatment))` categories. The key is to note that in table \@ref(tab:ex2t1) there exist several $2 \times 2$ tables for example

```{r nested2by2, echo=FALSE}
###see http://haozhu233.github.io/kableExtra/awesome_table_in_html.html
ex2t1a<-kable(table(z0[,c("treatment","BM")])%>%{.[1:2,]}%>%addmargins,caption="a) rows A and B")
kable_styling(ex2t1a,"striped", position = "float_left",full_width = F)%>% add_header_above(c("treatment","BM"=2," "))

ex2t1b<-kable(table(z0[,c("treatment","BM")])%>%{.[c(1,3),]}%>%addmargins,caption="b) rows A and C")
kable_styling(ex2t1b,"striped", position = "left",full_width = F)%>% add_header_above(c("treatment","BM"=2," "))
```

So in these tables we can, indeed, calculate OR's, those OR's will asses the following diferences (or contrasts):

$$P(BM=Yes|Treatment=A)\; vs \;(BM=Yes|Treatment=B)$$
and 
$$P(BM=Yes|Treatment=A)\; vs \;(BM=Yes|Treatment=C)$$

The corresponding OR's are $OR_{A-B}$ and $OR_{A-C}$. In this setting, we are selecting treatment $A$ as the reference treatment, comparing the remaining treatments with it. Lets calculate those OR's.

```{r ORex2, echo=FALSE}
###see http://haozhu233.github.io/kableExtra/awesome_table_in_html.html
ORex2<-kable(oddsratio(table(z0$treatment,z0$BM))$measure,caption="OR's for reference treatment A, with 95% confidence intervals")
kable_styling(ORex2,"striped", position = "center",full_width = F)
```

So it seem that treatment $A$ has fewer cases of behavior modifications compared to the other treatments. It would be nice to have a graph wich allows us to see this more clearly. In fact this graph exists and is called mosaic plot
<center>
```{r rocg1, message = FALSE, warning =F, echo=F, fig.width=4, fig.height=3.5, fig.cap="mosaic plot for BM conditional probabiliteis"}
ggplot(data = z0) +
  geom_mosaic(aes(x = product(BM,treatment), fill=BM), na.rm=TRUE)+
  labs(x = "treatment",y="")+theme_bw()
```
</center>

This OR's approach for this $3\times 2$ can be modified, changing the reference treatment and obtaining diferent OR's. As stated in the previous section the order of the rows ans columns maters, so if we swap columns diferent OR's will be obtained, however it can be checked that these OR's for the swaped columns are the multiplicative inverse of the ones presented here.

# Logistic regression